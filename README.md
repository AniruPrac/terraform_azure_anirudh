# Terraform Anirudh

This project contains Terraform configurations for deploying infrastructure on Azure.

This repository contains Terraform configurations to deploy the following  Azure resources.
```
Resource Group
Virtual Network
Subnet
Load Balancer
Linux Virtual machine Scale Set
PostgreSQL Server
PostgreSQL database
```

# Steps to replicate this setup locally.

## Configuring Azure Account via Azure CLI 

Pick up your subscription and run the following commands by replacing with the placeholder **SUBSCRIPTION_ID**
```md
# Login to Azure Account
as login

# Get a list of subscriptions for the logged in account. (autogenerated)
az account list

# Get the details of a subscription. (autogenerated)
az account show

# Set a subscription to be the current active subscription. (autogenerated)
az account set --subscription="SUBSCRIPTION_ID"

Read more about the command in reference docs
https://docs.microsoft.com/en-US/cli/azure/account#az_account_list

az account list --query "[?user.name=='<Azure Account Email>'].{Name:name, ID:id, Default:isDefault}" --output Table
```

## Export following environment variables to setup azure authentication locally.
```bash
export ARM_SUBSCRIPTION_ID="<azure_subscription_id>"
export ARM_TENANT_ID="<azure_subscription_tenant_id>"
export ARM_CLIENT_ID="<service_principal_appid>"
export ARM_CLIENT_SECRET="<service_principal_password>"
```
```powershell
$env:ARM_CLIENT_ID="<service_principal_app_id>"
$env:ARM_SUBSCRIPTION_ID="<azure_subscription_id>"
$env:ARM_TENANT_ID="<azure_subscription_tenant_id>"
$env:ARM_CLIENT_SECRET="<service_principal_password>"
``` 

## Detailed overview of terraform configs:

All files are numbers from 01 to 13 for better understanding. 

**01-versions.tf:** file contain the required providers block 

**02-locals.tf:** This files contains some variables used in tagging the resources properly.

**03-random-resource.tf:** This file contains random provider which generates a random string of length 6, used in generating the resource names.

**04-generic-input-variables.tf:** This file contains few variables which has some commonly used variables across all resources.

**05-vnet-subnet-variables.tf:** This file contains variables for vnet and subnet resources. Proper description and comments are provided in the file 

**06-linux-vmss-variables.tf:** This file contains variables for creating Linux Virtual machine scale set.

**07-resource-group.tf:** This is a resource block. A resource group is created with tags picked from locals.tf.

**08-virtual-network.tf:** Creates a virtual network with address space **"10.1.0.0/16"**

**09-subnet.tf:** Creates a subnet, a network security group that allows TCP traffic on ports 80, 443, 22. Also associate this NSG to the created subnet. 

**10-loadbalancer.tf:** Load balancer needs some supporting resources. The following resources are created in this file:
    * Public Ip: Creates a front facing public ip to be attached to Load balancer.
    * Load Balancer: Creates the main load balancer resource.
    * Backend Address pool: Creates a backend address pool for instances.
    * Load Balancer Probe : Creates a health probe that detects the health of backend pool via TCP protocol and port 80.
    * Load Balancer Rule: Creates a Load Balancing rule to define how incoming traffic is distributed to all the instances within the backend pool. The load balancer is configured to use a 5 tuple hash to map traffic(Default option) to available servers

**11-linux-vmss.tf:** Creates a Linux Virtual machine scale set with 2 minimum instances. It is based on RHEL latest OS. The following resources are also created:
    * A network security group: To manage inbound traffic via ports "22, 80, 443". Using the dynamic block, 3 security rules are creates each from the ports 22, 80, 443.
    * A network interface card: Associated to the subnet that is already created.
    * A Data disk: To enable storage for VMS.

**12-postgresql.tf:** This file contains code to create a PostgreSQL server and a PostgreSQL database(PaaS Service)

**13-outputs.tf:** Contains the outputs of various resources. This helps in knowing the names of created resources.
